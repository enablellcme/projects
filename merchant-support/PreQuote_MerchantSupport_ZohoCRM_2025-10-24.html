<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pre-Quote Project Clarification — Merchant Support</title>
  <style>
    /* Enable Branded Colors */
    :root {
      --enable-primary: #005D8F;
      --enable-accent: #09F781;
      --enable-dark: #003D4F;
      --enable-light-bg: #EFF4F4;
      --enable-text-dark: #003D4F;
      --enable-text-muted: #005D8F;
      --enable-border: #005D8F40;
    }

    * { box-sizing: border-box; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--enable-light-bg); margin: 0; color: var(--enable-text-dark); }

    header { padding: 24px 20px; background: #fff; border-bottom: 3px solid var(--enable-primary); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,93,143,.1); }
    header h1 { margin: 0 0 8px 0; font-size: 24px; color: var(--enable-primary); }
    header p { margin: 0; color: var(--enable-text-muted); font-size: 14px; }

    main { max-width: 1200px; margin: 24px auto; padding: 0 16px 40px; }

    .card { background: #fff; border: 2px solid var(--enable-border); border-radius: 12px; padding: 24px; margin: 16px 0; box-shadow: 0 4px 12px rgba(0,93,143,.08); }

    h2 { font-size: 18px; margin: 0 0 8px; color: var(--enable-primary); border-bottom: 2px solid var(--enable-accent); padding-bottom: 6px; display: inline-block; }
    .sub { color: var(--enable-text-muted); font-size: 13px; margin: 6px 0 12px; display: block; }
    .hint { color: var(--enable-text-muted); font-size: 12px; font-style: italic; margin-top: 4px; }

    .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; }
    .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }

    label.block { display: block; margin: 8px 0; font-size: 14px; font-weight: 500; }

    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th { background: var(--enable-primary); color: #fff; padding: 10px 8px; text-align: left; font-weight: 600; font-size: 13px; }
    td { padding: 8px 6px; border-bottom: 1px solid var(--enable-border); vertical-align: top; }
    tfoot td { border-top: 3px solid var(--enable-primary); font-weight: 600; padding-top: 12px; }

    input, select, textarea { width: 100%; padding: 8px; border: 1px solid var(--enable-border); border-radius: 8px; font-size: 14px; background: #fff; }
    input:focus, select:focus, textarea:focus { outline: 2px solid var(--enable-accent); border-color: var(--enable-primary); }
    textarea { min-height: 60px; resize: vertical; }

    .compact-table td:first-child { width: 35%; font-weight: 500; }
    .compact-table textarea { min-height: 40px; }

    button { padding: 10px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: all 0.2s ease; font-size: 14px; }
    button.primary { background: var(--enable-primary); color: #fff; }
    button.primary:hover { background: var(--enable-dark); transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,93,143,.3); }
    button.accent { background: var(--enable-accent); color: var(--enable-dark); }
    button.accent:hover { background: #07d66d; transform: translateY(-1px); }
    button.ghost { background: #fff; border: 2px solid var(--enable-primary); color: var(--enable-primary); }
    button.ghost:hover { background: var(--enable-light-bg); }

    .actions { display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; margin-top: 16px; }
    .footnote { color: var(--enable-text-muted); font-size: 13px; margin-top: 12px; padding: 12px; background: var(--enable-light-bg); border-left: 3px solid var(--enable-accent); border-radius: 4px; line-height: 1.5; }

    .framework-box { background: var(--enable-light-bg); border-left: 4px solid var(--enable-accent); padding: 16px; margin: 12px 0; border-radius: 4px; }
    .framework-box ul { margin: 8px 0; padding-left: 24px; }
    .framework-box li { margin: 6px 0; }

    /* Modal Styles */
    .modal { display: none; position: fixed; z-index: 999999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); }
    .modal-content { background: #fff; margin: 3% auto; padding: 0; width: 90%; max-width: 900px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,93,143,.3); max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; }
    .modal-header { background: var(--enable-primary); color: #fff; padding: 20px 24px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h2 { margin: 0; font-size: 22px; }
    .modal-close { color: #fff; font-size: 32px; font-weight: bold; cursor: pointer; transition: all 0.2s; line-height: 1; padding: 0 8px; }
    .modal-close:hover { color: var(--enable-accent); transform: scale(1.1); }
    .modal-body { padding: 24px; overflow-y: auto; flex: 1; }
    .modal-body h3 { color: var(--enable-primary); margin: 24px 0 12px 0; font-size: 18px; border-bottom: 2px solid var(--enable-accent); padding-bottom: 6px; display: inline-block; }
    .modal-body h3:first-child { margin-top: 0; }
    .modal-body p { line-height: 1.6; margin: 12px 0; }
    .modal-body strong { color: var(--enable-text-dark); }
    .modal-body ul { margin: 8px 0; padding-left: 24px; }
    .modal-body li { margin: 6px 0; line-height: 1.5; }
    .modal-table { width: 100%; border-collapse: collapse; margin: 16px 0; }
    .modal-table th { background: var(--enable-primary); color: #fff; padding: 12px 10px; text-align: left; font-weight: 600; font-size: 14px; }
    .modal-table td { padding: 10px 10px; border-bottom: 1px solid var(--enable-border); vertical-align: top; }
    .modal-table tr:last-child td { border-bottom: none; }
    .info-box { background: var(--enable-light-bg); border-left: 4px solid var(--enable-accent); padding: 12px 16px; margin: 16px 0; border-radius: 4px; }
    .learn-more-btn { background: var(--enable-accent); color: var(--enable-dark); padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; margin-top: 8px; transition: all 0.2s; }
    .learn-more-btn:hover { background: #07d66d; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(9,247,129,.3); }

    .project-info { background: linear-gradient(135deg, var(--enable-primary), var(--enable-dark)); color: #fff; padding: 16px 20px; border-radius: 8px; margin: 16px 0; }
    .project-info h3 { margin: 0 0 8px 0; font-size: 16px; color: var(--enable-accent); }
    .project-info p { margin: 4px 0; font-size: 14px; }
    .project-info strong { color: var(--enable-accent); }

    @media print {
      .modal { position: static; background: none; }
      .modal-content { max-width: 100%; box-shadow: none; max-height: none; }
      .modal-close { display: none; }
    }
  </style>
</head>
<body>
  <header>
    <h1 id="pageTitle">Pre-Quote Project Clarification — Merchant Support</h1>
    <p>Zoho CRM Migration | Total Units: 69 (≈117 hours @ $247/unit)</p>
  </header>

  <main>
    <!-- Introduction -->
    <section class="card">
      <p style="margin:0 0 12px;font-size:14px;line-height:1.6">This form helps us understand your project needs and expectations before generating a formal quote. Review the deliverables below, select your preferred engagement mode (Essential, Collaborative, or Managed) for each item, and add any specific requirements or constraints. Once complete, download the JSON file and email it to us.</p>
      <p class="hint" style="margin:0"><strong>Note:</strong> This is a working document. We'll review your selections together and adjust as needed before finalizing the quote.</p>
    </section>

    <!-- Project Scope Overview -->
    <section class="card">
      <div class="project-info">
        <h3>Project Scope Overview</h3>
        <p><strong>Client:</strong> Merchant Support</p>
        <p><strong>Project:</strong> Zoho CRM Migration (Salesforce → Zoho)</p>
        <p><strong>Total Estimated Units:</strong> 69 units (≈117 hours)</p>
        <p><strong>Unit Rate:</strong> $247/unit | Hours per Unit: ~1.7</p>
      </div>
    </section>

    <!-- Client Information -->
    <section class="card">
      <h2>Client Information</h2>
      <span class="sub">Business and contact details for this project</span>

      <div class="grid-2" style="margin-top:12px">
        <div><label class="block">Business/Client Name<input type="text" id="businessName" value="Merchant Support" placeholder="Company name" data-zoho-field="Account_Name"/></label></div>
        <div><label class="block">Contact Name<input type="text" id="contactName" value="Bharti Sharma" placeholder="Primary contact" data-zoho-field="Contact_Name"/></label></div>
        <div><label class="block">Email<input type="email" id="email" value="bsharma@merchantsupport.com" placeholder="contact@company.com" data-zoho-field="Email"/></label></div>
        <div><label class="block">Phone<input type="tel" id="phone" placeholder="(555) 123-4567" data-zoho-field="Phone"/></label></div>
      </div>
    </section>

    <!-- Enablement Framework -->
    <section class="card">
      <h2>Enablement Framework</h2>
      <span class="sub">Choose how Enable partners with you on each deliverable</span>

      <div class="framework-box">
        <ul>
          <li><strong>Essential</strong> → Light touch: Enable sets up the foundation; client manages day-to-day operations</li>
          <li><strong>Collaborative</strong> → Shared effort: Enable handles technical strategy; client operates systems</li>
          <li><strong>Managed</strong> → Full service: Enable owns delivery, optimization, and ongoing management</li>
          <li><strong>Exclude</strong> → Not included in this phase</li>
        </ul>
        <button type="button" class="learn-more-btn" onclick="openServiceLevelsModal()">📖 Learn More About Service Levels</button>
      </div>
      <p class="hint">Unit-based billing applies: 1 unit ≈ 1.7 hours of work @ $247/unit. Select the engagement mode for each deliverable below.</p>
    </section>

    <!-- Feature Selection -->
    <section class="card">
      <h2>Deliverables & Engagement Mode</h2>
      <span class="sub">Select which deliverables to include and choose the engagement mode for each</span>

      <table>
        <thead>
          <tr>
            <th style="width:40px">✓</th>
            <th>Feature / Deliverable</th>
            <th style="width:140px">Mode</th>
            <th style="width:80px;text-align:right">Units</th>
            <th style="width:25%">Notes</th>
          </tr>
        </thead>
        <tbody id="features-body"></tbody>
        <tfoot>
          <tr>
            <td colspan="2"><strong>Totals by Mode & Overall</strong></td>
            <td colspan="1" id="modeTotals" style="font-size:12px"></td>
            <td id="unitTotal" style="text-align:right;font-size:16px"></td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </section>

    <!-- Commercial Options (Payment) -->
    <section class="card">
      <h2>Commercial Options & Payment Terms</h2>
      <span class="sub">Select your preferred engagement and payment model (per SOW)</span>

      <div style="margin:16px 0">
        <label style="display:block;margin:12px 0;padding:16px;border:2px solid var(--enable-border);border-radius:8px;cursor:pointer;transition:all 0.2s">
          <input type="radio" name="commercialOption" value="fixed_rate" id="optionA" style="width:auto;margin-right:8px" checked>
          <strong style="font-size:16px">Option A — Fixed-Rate Engagement</strong>
          <div style="margin:8px 0 0 28px;font-size:14px;color:var(--enable-text-muted)">
            <p style="margin:4px 0"><strong>Total Budget:</strong> $22,000 USD (fixed)</p>
            <p style="margin:4px 0"><strong>Deposit:</strong> Full amount due upon signature to initiate development</p>
            <p style="margin:4px 0"><strong>Billing Terms:</strong> One-time invoice at project start</p>
            <p style="margin:4px 0"><strong>Includes:</strong> All deliverables listed above plus two minor revisions</p>
            <p style="margin:4px 0;font-size:12px;font-style:italic">✓ Predictable fixed cost | ✓ Clearly defined milestones | ✓ Simplified invoicing</p>
          </div>
        </label>

        <label style="display:block;margin:12px 0;padding:16px;border:2px solid var(--enable-border);border-radius:8px;cursor:pointer;transition:all 0.2s">
          <input type="radio" name="commercialOption" value="time_materials" id="optionB" style="width:auto;margin-right:8px">
          <strong style="font-size:16px">Option B — Time & Materials (T&M) Engagement</strong>
          <div style="margin:8px 0 0 28px;font-size:14px;color:var(--enable-text-muted)">
            <p style="margin:4px 0"><strong>Estimated Range:</strong> $17,000 – $26,000 USD</p>
            <p style="margin:4px 0"><strong>Baseline Rate:</strong> $247 per unit (≈ $145/hr)</p>
            <p style="margin:4px 0"><strong>Deposit:</strong> Equivalent to approximately two weeks of projected effort at project start</p>
            <p style="margin:4px 0"><strong>Billing Cycle:</strong> Weekly or bi-weekly based on actual hours worked</p>
            <p style="margin:4px 0"><strong>Scope Flexibility:</strong> Client may adjust deliverables mid-project</p>
            <p style="margin:4px 0;font-size:12px;font-style:italic">✓ Adjusts to evolving requirements | ✓ Transparent tracking | ✓ Iterative collaboration</p>
          </div>
        </label>
      </div>

      <div id="tmBillingFrequency" style="margin-top:16px;display:none">
        <label class="block">Billing Frequency (T&M only)</label>
        <select id="billingFreq">
          <option value="weekly">Weekly</option>
          <option value="biweekly">Bi-weekly</option>
          <option value="monthly">Monthly</option>
        </select>
      </div>

      <div style="margin-top:16px">
        <label class="block">Payment Method</label>
        <select id="paymentMethod">
          <option value="ach">ACH</option>
          <option value="check">Check</option>
          <option value="cc">Credit Card (3% fee)</option>
        </select>
      </div>

      <label class="block" style="margin-top:16px">Additional Budget Notes / Constraints<textarea id="budgetNotes" placeholder="Any budget caps, approval thresholds, or special considerations" style="margin-top:4px"></textarea></label>
    </section>

    <!-- Timeline & Phasing -->
    <section class="card">
      <h2>Timeline & Phasing</h2>
      <span class="sub">Define project phases, milestones, and go-live timeline</span>
      <textarea id="timelineNotes" placeholder="Specify go-live phases: initial, core, and post-support timelines" style="margin-top:8px"></textarea>
    </section>

    <!-- Additional Notes -->
    <section class="card">
      <h2>Additional Notes</h2>
      <span class="sub">Any other project considerations, constraints, or requirements</span>
      <textarea id="generalNotes" placeholder="List any additional project considerations" style="margin-top:8px"></textarea>

      <div class="actions">
        <button type="button" class="ghost" id="resetBtn">Reset Form</button>
        <button type="button" class="ghost" id="importJsonBtn">Import JSON</button>
        <button type="button" class="ghost" onclick="window.print()">Print / Save as PDF</button>
        <button type="button" class="ghost" id="downloadTxtBtn">Download Text</button>
        <button type="button" class="primary" id="copyJsonBtn">Copy JSON</button>
        <button type="button" class="accent" id="downloadJsonBtn">Download JSON</button>
        <button type="button" class="ghost" id="exportHtmlBtn">Export Pre-filled HTML</button>
      </div>
      <input type="file" id="jsonFileInput" accept="application/json,.json" style="display:none;" />

      <div class="footnote">
        <strong>Client Workflow:</strong> Fill out form → Download JSON → Email to Enable<br>
        <strong>Enable Workflow:</strong> Import JSON → Review/adjust → Export Pre-filled HTML → Send to client for approval<br>
        Use <em>Print / Save as PDF</em> for your records.
      </div>
    </section>

    <!-- Service Levels Modal -->
    <div id="serviceLevelsModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Enable Service Levels Overview</h2>
          <span class="modal-close" onclick="closeServiceLevelsModal()">&times;</span>
        </div>
        <div class="modal-body">
          <p>Enable Workspace offers three distinct levels of service — <strong>Essentials</strong>, <strong>Collaborative</strong>, and <strong>Managed</strong> — designed to fit the level of partnership and support each client needs. This structure provides clarity, scalability, and confidence when choosing how Enable integrates with your business.</p>

          <h3>1. Essentials — You Build, We Guide</h3>
          <p><strong>Definition:</strong> Essentials is the foundation tier for clients who want to stay hands-on while leveraging Enable's frameworks and proven setup process. We provide the tools and structure; you drive the day-to-day operations.</p>

          <p><strong>Included Support:</strong></p>
          <ul>
            <li>One-time system setup and implementation</li>
            <li>Foundational automations and templates</li>
            <li>Access to documentation, playbooks, and training videos</li>
            <li>Email or ticket-based Q&A support during setup</li>
          </ul>

          <p><strong>Example Scenarios:</strong></p>
          <ul>
            <li>Enable configures your CRM, but your team manages leads, pipelines, and follow-ups</li>
            <li>Enable provides automation templates for onboarding workflows; your team runs them internally</li>
            <li>Enable builds analytics dashboards; your team updates and interprets data</li>
          </ul>

          <p><strong>Ideal Client:</strong> Startups or lean teams who want expert setup and control execution in-house.</p>

          <h3>2. Collaborative — We Build Together</h3>
          <p><strong>Definition:</strong> A balanced, hybrid approach where Enable and your team share responsibilities. We handle the technical strategy and optimization, while you manage daily operations. It's a partnership designed for growth and learning.</p>

          <p><strong>Included Support:</strong></p>
          <ul>
            <li>Shared management of systems and workflows</li>
            <li>Scheduled strategy and review meetings</li>
            <li>Co-development of automations, integrations, or campaigns</li>
            <li>Priority access to Enable's support and expertise</li>
          </ul>

          <p><strong>Example Scenarios:</strong></p>
          <ul>
            <li>Enable builds and optimizes automations; your team manages customer interactions and content</li>
            <li>Biweekly check-ins where Enable reviews metrics and recommends updates</li>
            <li>Split CRM ownership — Enable refines structure and data integrity; your team runs operations</li>
          </ul>

          <p><strong>Ideal Client:</strong> Growth-stage businesses seeking to scale operations with guidance but still maintain hands-on control.</p>

          <h3>3. Managed — We Handle It All</h3>
          <p><strong>Definition:</strong> Enable takes full responsibility for implementation, management, and optimization of your systems. Your focus stays on business strategy while we run the technology and operations behind it.</p>

          <p><strong>Included Support:</strong></p>
          <ul>
            <li>End-to-end management of all systems, campaigns, and workflows</li>
            <li>Dedicated account manager and technical lead</li>
            <li>Continuous optimization, monitoring, and performance reporting</li>
            <li>Strategic planning sessions with actionable insights</li>
          </ul>

          <p><strong>Example Scenarios:</strong></p>
          <ul>
            <li>Enable manages all CRM automations, reporting, and marketing campaigns from setup to delivery</li>
            <li>Monthly data reviews and performance reports with proactive system improvements</li>
            <li>Enable oversees integrations, troubleshooting, and day-to-day execution</li>
          </ul>

          <p><strong>Ideal Client:</strong> Scaling or resource-limited teams that want a turnkey system without internal management overhead.</p>

          <h3>Comparison Snapshot</h3>
          <table class="modal-table">
            <thead>
              <tr>
                <th>Tier</th>
                <th>Description</th>
                <th>Enable's Role</th>
                <th>Client's Role</th>
                <th>Ideal Fit</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Essentials</strong></td>
                <td>DIY with Enable's foundation</td>
                <td>Setup & training</td>
                <td>Manage daily operations</td>
                <td>Startups & small teams</td>
              </tr>
              <tr>
                <td><strong>Collaborative</strong></td>
                <td>Shared management and strategy</td>
                <td>Build & optimize</td>
                <td>Operate systems</td>
                <td>Growing SMBs</td>
              </tr>
              <tr>
                <td><strong>Managed</strong></td>
                <td>Full-service execution</td>
                <td>Own & operate</td>
                <td>Approve & oversee</td>
                <td>Scaling or enterprise teams</td>
              </tr>
            </tbody>
          </table>

          <div class="info-box">
            <p style="margin:0"><strong>Forward View:</strong> As Enable continues evolving, each tier will integrate intelligent automation, AI-powered reporting, and predictive insights — ensuring that no matter where a client starts, they can scale effortlessly into the next stage of Enable's ecosystem.</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // ============================================
    // MERCHANT SUPPORT - ZOHO CRM MIGRATION
    // ============================================
    // Client: Merchant Support
    // Contact: Bharti Sharma (bsharma@merchantsupport.com)
    // Project: Zoho CRM Migration (Salesforce → Zoho)
    // Total Units: 69 (≈117 hours @ $247/unit)
    // Created: 2025-10-24
    // ============================================

    // Catalog with deliverables from Merchant Support project JSON
    // Units are set based on provided estimates (Managed tier)
    // Essential and Collaborative tiers calculated as 70% and 85% of Managed
    const CATALOG = [
      {
        label:'CRM Configuration & Core Modules',
        description:'Configure Zoho CRM core modules (Accounts, Contacts, Deals, Partners, Agents) including custom fields, layouts, and pipelines.',
        units:{essential:8,collaborative:10,managed:12},
        recommended:'managed'
      },
      {
        label:'Dashboards & Reporting',
        description:'Create dashboards for sales volume, deal stages, and partner performance with six widgets and three exportable reports.',
        units:{essential:6,collaborative:7,managed:8},
        recommended:'managed'
      },
      {
        label:'Residuals / Commission Management Module',
        description:'Develop a custom Zoho module for monthly residual uploads, mapping, matching, split-commission logic, and reconciliation reports.',
        units:{essential:13,collaborative:15,managed:18},
        recommended:'managed'
      },
      {
        label:'Email Automation & Workflow Rules',
        description:'Setup templated emails and automation workflows for merchant onboarding, partner updates, and deal notifications. Up to five automated workflows.',
        units:{essential:5,collaborative:5,managed:5},
        recommended:'managed'
      },
      {
        label:'Data Migration (Salesforce → Zoho)',
        description:'Export, clean, deduplicate, and import Salesforce data into Zoho, preserving historical records and relationships.',
        units:{essential:12,collaborative:14,managed:17},
        recommended:'managed'
      },
      {
        label:'Testing & Training (UAT Phase)',
        description:'Conduct UAT sessions, issue resolution, and two training sessions with supporting documentation and recordings.',
        units:{essential:7,collaborative:9,managed:10},
        recommended:'collaborative'
      }
    ];

    const modes = ['essential','collaborative','managed','exclude'];

    const tbody = document.getElementById('features-body');

    function titleCase(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

    function createRow(item) {
      const tr = document.createElement('tr');
      const chk = document.createElement('input'); chk.type = 'checkbox'; chk.checked = true;
      const td0 = document.createElement('td'); td0.appendChild(chk);

      const td1 = document.createElement('td');
      const labelDiv = document.createElement('div');
      labelDiv.innerHTML = `<strong>${item.label}</strong>`;
      if (item.description) {
        const descDiv = document.createElement('div');
        descDiv.style.fontSize = '12px';
        descDiv.style.color = 'var(--enable-text-muted)';
        descDiv.style.marginTop = '4px';
        descDiv.textContent = item.description;
        labelDiv.appendChild(descDiv);
      }
      td1.appendChild(labelDiv);

      const td2 = document.createElement('td');
      const sel = document.createElement('select');
      modes.forEach(m => {
        const o = document.createElement('option');
        o.value = m;
        o.textContent = titleCase(m);
        sel.appendChild(o);
      });
      sel.value = item.recommended || 'managed';
      td2.appendChild(sel);
      const td3 = document.createElement('td'); td3.style.textAlign = 'right';
      const span = document.createElement('span'); td3.appendChild(span);
      const td4 = document.createElement('td');
      const note = document.createElement('textarea'); td4.appendChild(note);
      tr.append(td0, td1, td2, td3, td4);

      function recalc() {
        const val = sel.value;
        const on = chk.checked;
        let u = 0;
        if (on && val !== 'exclude') { u = item.units[val]; }
        span.textContent = u;
        updateTotals();
      }
      sel.addEventListener('change', recalc);
      chk.addEventListener('change', recalc);
      recalc();
      return tr;
    }

    function build() {
      tbody.innerHTML = '';
      CATALOG.forEach(i => tbody.appendChild(createRow(i)));
      document.getElementById('paymentMethod').value = 'ach';
      updateTotals();
      updatePageTitle();
    }

    function updateTotals() {
      let tEss = 0, tCol = 0, tMan = 0, tAll = 0;
      document.querySelectorAll('#features-body tr').forEach(tr => {
        const sel = tr.querySelector('select').value;
        const chk = tr.querySelector('input[type=checkbox]').checked;
        const units = Number(tr.querySelector('td:nth-child(4) span').textContent) || 0;
        if (!chk || sel === 'exclude') return;
        if (sel === 'essential') tEss += units;
        if (sel === 'collaborative') tCol += units;
        if (sel === 'managed') tMan += units;
        tAll += units;
      });
      document.getElementById('modeTotals').innerText = `Ess: ${tEss} • Collab: ${tCol} • Mgd: ${tMan}`;
      document.getElementById('unitTotal').innerText = tAll;
    }

    function updatePageTitle() {
      const businessName = document.getElementById('businessName').value.trim();
      const titleEl = document.getElementById('pageTitle');
      if (businessName) {
        titleEl.textContent = `Pre-Quote Project Clarification — ${businessName}`;
        document.title = `Pre-Quote Project Clarification — ${businessName}`;
      } else {
        titleEl.textContent = 'Pre-Quote Project Clarification Decision Guide';
        document.title = 'Pre-Quote Project Clarification Decision Guide';
      }
    }

    // Update title when business name changes
    document.getElementById('businessName').addEventListener('input', updatePageTitle);

    function collectJSON() {
      const features = [];
      document.querySelectorAll('#features-body tr').forEach(tr => {
        const chk = tr.querySelector('input[type=checkbox]').checked;
        const mode = tr.querySelector('select').value;
        const label = tr.children[1].querySelector('strong').textContent;
        const units = Number(tr.children[3].querySelector('span').textContent) || 0;
        const notes = tr.children[4].querySelector('textarea').value.trim();
        if (!chk) return;
        features.push({label, mode, units, notes});
      });

      const commercialOption = document.querySelector('input[name="commercialOption"]:checked').value;
      const billingFreq = document.getElementById('billingFreq').value;

      return {
        meta: {
          form: 'Enable Pre-Quote Project Clarification - Merchant Support',
          client: 'Merchant Support',
          project: 'Zoho CRM Migration',
          version: '3.2.0',
          generated_at: new Date().toISOString(),
          sow_reference: 'Enable Merchant Support SOW_10-24-2025.pdf'
        },
        client_info: {
          business_name: document.getElementById('businessName').value.trim(),
          contact_name: document.getElementById('contactName').value.trim(),
          email: document.getElementById('email').value.trim(),
          phone: document.getElementById('phone').value.trim()
        },
        commercial_option: {
          model: commercialOption,
          model_name: commercialOption === 'fixed_rate' ? 'Option A — Fixed-Rate ($22,000)' : 'Option B — Time & Materials ($17K-$26K)',
          billing_frequency: commercialOption === 'time_materials' ? billingFreq : 'one-time',
          payment_method: document.getElementById('paymentMethod').value
        },
        timeline: document.getElementById('timelineNotes').value.trim(),
        budget_notes: document.getElementById('budgetNotes').value.trim(),
        additional_notes: document.getElementById('generalNotes').value.trim(),
        features,
        totals: {
          by_mode: document.getElementById('modeTotals').innerText,
          units: Number(document.getElementById('unitTotal').innerText)
        }
      };
    }

    function copyJSON() {
      const text = JSON.stringify(collectJSON(), null, 2);
      navigator.clipboard.writeText(text).then(() => alert('JSON copied to clipboard!')).catch(() => {
        const w = window.open('', '_blank');
        w.document.write(`<pre>${text.replace(/[&<>]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]))}</pre>`);
        w.document.close();
      });
    }

    function downloadJson() {
      const text = JSON.stringify(collectJSON(), null, 2);
      const blob = new Blob([text], {type: 'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      const businessName = document.getElementById('businessName').value.trim().replace(/[^a-z0-9]/gi, '_') || 'Client';
      a.download = `PreQuote_${businessName}_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(() => URL.revokeObjectURL(a.href), 1000);
    }

    function downloadTxt() {
      const text = JSON.stringify(collectJSON(), null, 2);
      const blob = new Blob([text], {type: 'text/plain'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      const businessName = document.getElementById('businessName').value.trim().replace(/[^a-z0-9]/gi, '_') || 'Client';
      a.download = `PreQuote_${businessName}_${new Date().toISOString().split('T')[0]}.txt`;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(() => URL.revokeObjectURL(a.href), 1000);
    }

    function populateForm(data) {
      // Populate client info
      if (data.client_info) {
        if (data.client_info.business_name) document.getElementById('businessName').value = data.client_info.business_name;
        if (data.client_info.contact_name) document.getElementById('contactName').value = data.client_info.contact_name;
        if (data.client_info.email) document.getElementById('email').value = data.client_info.email;
        if (data.client_info.phone) document.getElementById('phone').value = data.client_info.phone;
        updatePageTitle();
      }

      // Populate commercial option (new structure) or legacy payment structure
      if (data.commercial_option) {
        if (data.commercial_option.model === 'fixed_rate') {
          document.getElementById('optionA').checked = true;
        } else if (data.commercial_option.model === 'time_materials') {
          document.getElementById('optionB').checked = true;
        }
        if (data.commercial_option.billing_frequency) {
          document.getElementById('billingFreq').value = data.commercial_option.billing_frequency;
        }
        if (data.commercial_option.payment_method) {
          document.getElementById('paymentMethod').value = data.commercial_option.payment_method;
        }
        toggleBillingFrequency();
      } else if (data.payment) {
        // Legacy support for old payment structure
        if (data.payment.method) document.getElementById('paymentMethod').value = data.payment.method;
      }

      // Populate text fields
      if (data.timeline) document.getElementById('timelineNotes').value = data.timeline;
      if (data.budget_notes) document.getElementById('budgetNotes').value = data.budget_notes;
      if (data.additional_notes) document.getElementById('generalNotes').value = data.additional_notes;

      // Populate features
      if (data.features && data.features.length > 0) {
        const rows = document.querySelectorAll('#features-body tr');
        data.features.forEach(feature => {
          rows.forEach(row => {
            const label = row.children[1].querySelector('strong').textContent;
            if (label === feature.label) {
              row.querySelector('input[type=checkbox]').checked = true;
              row.querySelector('select').value = feature.mode;
              if (feature.notes) row.querySelector('textarea').value = feature.notes;
              row.querySelector('select').dispatchEvent(new Event('change'));
            }
          });
        });
      }
      alert('Form data loaded successfully!');
    }

    function importJson() {
      document.getElementById('jsonFileInput').click();
    }

    function handleFileImport(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          populateForm(data);
        } catch (err) {
          alert('Error reading JSON file: ' + err.message);
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    function exportPrefilledHtml() {
      const currentData = collectJSON();
      const htmlDoc = document.documentElement.outerHTML;
      const dataScript = `
    <script id="prefilled-data">
      window.addEventListener('DOMContentLoaded', function() {
        const prefilledData = ${JSON.stringify(currentData, null, 2)};
        setTimeout(function() {
          populateForm(prefilledData);
          document.getElementById('prefilled-data').remove();
        }, 100);
      });
    </scr` + `ipt>`;
      const modifiedHtml = htmlDoc.replace('</body>', dataScript + '\n</body>');
      const blob = new Blob([modifiedHtml], {type: 'text/html'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      const businessName = document.getElementById('businessName').value.trim().replace(/[^a-z0-9]/gi, '_') || 'Client';
      a.download = `PreQuote_${businessName}_Prefilled.html`;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(() => URL.revokeObjectURL(a.href), 1000);
    }

    function resetForm() {
      if (!confirm('Reset all selections? This cannot be undone.')) return;
      build();
      document.querySelectorAll('input[type=text], input[type=email], input[type=tel], textarea').forEach(el => el.value = '');
      // Restore pre-filled client info
      document.getElementById('businessName').value = 'Merchant Support';
      document.getElementById('contactName').value = 'Bharti Sharma';
      document.getElementById('email').value = 'bsharma@merchantsupport.com';
      updatePageTitle();
    }

    // Toggle billing frequency visibility based on commercial option
    function toggleBillingFrequency() {
      const tmSelected = document.getElementById('optionB').checked;
      document.getElementById('tmBillingFrequency').style.display = tmSelected ? 'block' : 'none';
    }
    document.getElementById('optionA').addEventListener('change', toggleBillingFrequency);
    document.getElementById('optionB').addEventListener('change', toggleBillingFrequency);

    document.getElementById('downloadJsonBtn').addEventListener('click', downloadJson);
    document.getElementById('copyJsonBtn').addEventListener('click', copyJSON);
    document.getElementById('importJsonBtn').addEventListener('click', importJson);
    document.getElementById('exportHtmlBtn').addEventListener('click', exportPrefilledHtml);
    document.getElementById('jsonFileInput').addEventListener('change', handleFileImport);
    document.getElementById('downloadTxtBtn').addEventListener('click', downloadTxt);
    document.getElementById('resetBtn').addEventListener('click', resetForm);

    // Service Levels Modal Functions
    function openServiceLevelsModal() {
      document.getElementById('serviceLevelsModal').style.display = 'block';
      document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }

    function closeServiceLevelsModal() {
      document.getElementById('serviceLevelsModal').style.display = 'none';
      document.body.style.overflow = 'auto'; // Restore scrolling
    }

    // Close modal when clicking outside of it
    window.onclick = function(event) {
      const modal = document.getElementById('serviceLevelsModal');
      if (event.target === modal) {
        closeServiceLevelsModal();
      }
    }

    // Close modal with Escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeServiceLevelsModal();
      }
    });

    build();
  </script>
</body>
</html>
